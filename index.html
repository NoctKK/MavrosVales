<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÎœÎ±ÏÏÎ¿Ï‚ Î’Î±Î»Î­Ï‚ Online</title>
    <style>
        :root { --gold: #d4af37; --bg-gradient: radial-gradient(circle at center, #2e5c3e 0%, #0f2b1d 100%); }
        body { background: var(--bg-gradient); color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; overflow: hidden; height: 100vh; user-select: none; -webkit-user-select: none; }

        /* SCOREBOARD */
        #scoreboard { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); border: 1px solid var(--gold); border-radius: 8px; padding: 5px; z-index: 1500; font-size: 14px; display: none; max-height: 200px; overflow-y: auto; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #555; padding: 4px 8px; text-align: center; }
        th { color: var(--gold); }
        .wc-text { color: #4f4; font-weight: bold; }

        /* OVERLAY MESSAGES */
        #msg-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2500; display: none; align-items: center; justify-content: center; font-size: 40px; color: var(--gold); text-align: center; font-weight: bold; animation: fadeIn 0.3s; }

        /* Start Screen */
        #start-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .title-logo { font-size: 50px; color: var(--gold); text-shadow: 0 0 20px rgba(212, 175, 55, 0.5); margin-bottom: 10px; text-align: center; }
        .start-btn { padding: 15px 40px; font-size: 20px; background: var(--gold); color: #111; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 0 15px var(--gold); opacity: 0.5; pointer-events: none; transition: all 0.3s; margin-top: 20px; }
        .start-btn.active { opacity: 1; pointer-events: all; transform: scale(1.1); }

        #final-screen { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; flex-direction: column; align-items: center; justify-content: center; }
        
        #turn-indicator { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); padding: 8px 20px; background: rgba(0,0,0,0.8); border: 2px solid #555; border-radius: 20px; font-size: 16px; font-weight: bold; z-index: 1000; white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        #suit-indicator { position: absolute; top: 32%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; background: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 35px; box-shadow: 0 0 15px white; z-index: 5; }

        #table { width: 100%; height: 100%; position: relative; }
        .center-stack { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 20px; }
        .opponent { position: absolute; display: flex; flex-direction: column; align-items: center; }
        .opp-name { background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-bottom: 2px; color: #ddd; }
        .opp-top { top: 60px; left: 50%; transform: translateX(-50%); }
        .opp-left { left: 20px; top: 40%; transform: translateY(-50%); }
        .opp-right { right: 20px; top: 40%; transform: translateY(-50%); }
        .mini-card { width: 22px; height: 32px; background: linear-gradient(135deg, #a00, #500); border: 1px solid #fff; border-radius: 3px; margin-left: -16px; box-shadow: 1px 1px 3px black; }

        .card { width: 80px; height: 120px; background: white; color: black; border-radius: 8px; border: 1px solid #999; display: flex; flex-direction: column; justify-content: space-between; padding: 5px; box-sizing: border-box; position: relative; font-weight: bold; font-size: 18px; box-shadow: 3px 3px 8px rgba(0,0,0,0.4); cursor: pointer; transition: transform 0.1s; }
        .card.red { color: #d00; }
        .card.back { background: linear-gradient(135deg, #8e2424 0%, #4d0000 100%); border: 2px solid #eee; display: flex; align-items: center; justify-content: center; color: #eee; text-align: center; }
        .new-card { animation: slideFast 0.15s ease-out; }
        @keyframes slideFast { from { transform: translateY(50px) scale(0.8); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        #my-hand { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; height: 140px; }
        .hand-card { margin-left: -45px; transition: margin 0.1s, transform 0.1s; transform-origin: bottom center; box-shadow: -2px 0 5px rgba(0,0,0,0.3); }
        .hand-card:first-child { margin-left: 0; }
        .hand-card:hover { transform: translateY(-30px) scale(1.1); margin-right: 20px; z-index: 100; }

        #controls { position: absolute; bottom: 180px; right: 20px; }
        .pass-btn { padding: 10px 25px; background: rgba(0,0,0,0.5); color: white; border: 1px solid var(--gold); border-radius: 20px; cursor: pointer; }

        #ace-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; flex-direction: column; align-items: center; justify-content: center; }
        .suit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px; }
        .suit-btn { width: 70px; height: 70px; font-size: 40px; background: white; border: 3px solid var(--gold); border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; }
        
        .shake { animation: shake 0.2s; border-color: red !important; }
        @keyframes shake { 0%, 100% {transform:translateX(0);} 25% {transform:translateX(-5px);} 75% {transform:translateX(5px);} }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }
        @media (max-width: 600px) { .card { width: 65px; height: 95px; font-size: 16px; } .suit-btn { width: 60px; height: 60px; } .title-logo { font-size: 35px; } }
    </style>
</head>
<body>
    <div id="start-screen">
        <div class="title-logo">ÎœÎ±ÏÏÎ¿Ï‚ Î’Î±Î»Î­Ï‚ â™ </div>
        <div id="waiting-msg" style="color:#aaa; text-align:center;">Î£Ï…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Î¹ Ï€Î±Î¯ÎºÏ„ÎµÏ‚: 1<br>Î ÎµÏÎ¯Î¼ÎµÎ½Îµ...</div>
        <button id="start-btn" class="start-btn" onclick="socket.emit('startGameRequest')">ÎÎ•ÎšÎ™ÎÎ—Î£Î• Î¤ÎŸ ÎœÎŸÎ™Î¡Î‘Î£ÎœÎ‘</button>
    </div>
    <div id="msg-overlay"></div>
    <div id="final-screen">
        <div class="title-logo">Î¤Î•Î›ÎŸÎ£ Î Î‘Î™Î§ÎÎ™Î”Î™ÎŸÎ¥ ğŸ†</div>
        <div id="final-scores" style="font-size:24px; margin:20px;"></div>
        <button class="start-btn active" onclick="location.reload()">Î Î‘Î™ÎÎ• ÎÎ‘ÎÎ‘</button>
    </div>
    <div id="scoreboard"><table id="score-table"></table></div>
    <div id="turn-indicator">Î‘Î½Î±Î¼Î¿Î½Î®...</div>
    <div id="suit-indicator"></div>

    <div id="ace-modal">
        <h2 style="color:var(--gold);">Î”Î¹Î¬Î»ÎµÎ¾Îµ Î§ÏÏÎ¼Î±</h2>
        <div class="suit-grid">
            <div class="suit-btn" style="color:red" onclick="confirmAce('â™¥')">â™¥</div>
            <div class="suit-btn" style="color:red" onclick="confirmAce('â™¦')">â™¦</div>
            <div class="suit-btn" style="color:black" onclick="confirmAce('â™£')">â™£</div>
            <div class="suit-btn" style="color:black" onclick="confirmAce('â™ ')">â™ </div>
        </div>
        <button class="pass-btn" onclick="confirmAce(null)">Î§Ï‰ÏÎ¯Ï‚ Î‘Î»Î»Î±Î³Î®</button>
    </div>

    <div id="table">
        <div id="opp-top" class="opponent opp-top"></div>
        <div id="opp-left" class="opponent opp-left"></div>
        <div id="opp-right" class="opponent opp-right"></div>
        <div class="center-stack">
            <div class="card back" id="draw-pile" onclick="drawCardAnim()">
                <div style="font-size:12px">Î¤Î¡Î‘Î’Î‘</div>
            </div>
            <div id="top-card-spot"></div>
        </div>
        <div id="controls"><button class="pass-btn" onclick="socket.emit('passTurn')">Î Î‘Î£ÎŸ â­ï¸</button></div>
        <div id="my-hand"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myId = null;
        let selectedAceIndex = null;
        let currentTopCard = null; // Î“Î¹Î± Î­Î»ÎµÎ³Ï‡Î¿ Î†ÏƒÏƒÎ¿Ï…

        // Keep Alive (Î“Î¹Î± Î½Î± Î¼Î·Î½ ÎºÎ»ÎµÎ¯Î½ÎµÎ¹ Ï„Î¿ Render)
        setInterval(() => { fetch('/ping').catch(() => {}); }, 60000);

        socket.on('connect', () => myId = socket.id);

        socket.on('playerCountUpdate', (count) => {
            const btn = document.getElementById('start-btn');
            const msg = document.getElementById('waiting-msg');
            msg.innerHTML = `Î£Ï…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Î¹ Ï€Î±Î¯ÎºÏ„ÎµÏ‚: ${count}`;
            if (count >= 2) {
                btn.classList.add('active');
                msg.innerHTML += `<br><span style="color:#4f4">Î•Î¯ÏƒÏ„Îµ Î­Ï„Î¿Î¹Î¼Î¿Î¹!</span>`;
            } else { btn.classList.remove('active'); }
        });

        socket.on('gameReady', () => {
            document.getElementById('start-screen').style.opacity = '0';
            setTimeout(() => document.getElementById('start-screen').style.display = 'none', 500);
            document.getElementById('scoreboard').style.display = 'block';
        });

        socket.on('updateScoreboard', (history) => {
            const table = document.getElementById('score-table');
            if (history.length === 0) { table.innerHTML = ''; return; }
            let playerNames = Object.keys(history[0]);
            let html = `<tr>${playerNames.map(name => `<th>${name}</th>`).join('')}</tr>`;
            history.forEach(round => {
                html += '<tr>';
                playerNames.forEach(name => {
                    let val = round[name];
                    let display = (val === "WC") ? '<span class="wc-text">WC</span>' : val;
                    html += `<td>${display}</td>`;
                });
                html += '</tr>';
            });
            table.innerHTML = html;
            document.getElementById('scoreboard').scrollTop = document.getElementById('scoreboard').scrollHeight;
        });

        socket.on('roundResultMsg', (text) => {
            const overlay = document.getElementById('msg-overlay');
            overlay.innerHTML = text;
            overlay.style.display = 'flex';
            setTimeout(() => { overlay.style.display = 'none'; }, 3500);
        });

        socket.on('gameOver', (sortedPlayers) => {
            document.getElementById('final-screen').style.display = 'flex';
            const list = document.getElementById('final-scores');
            let html = '';
            sortedPlayers.forEach((p, index) => {
                let icon = index === 0 ? 'ğŸ‘‘' : 'ğŸ’€';
                html += `<div style="margin-bottom:10px; color:${index===0?'#4f4':'white'}">
                            ${icon} ${p.name}: ${p.totalScore} Ï€ÏŒÎ½Ï„Î¿Î¹
                         </div>`;
            });
            list.innerHTML = html;
        });
        
        socket.on('gameEndedForced', () => location.reload());

        socket.on('updateUI', (data) => {
            const ind = document.getElementById('turn-indicator');
            const drawPile = document.getElementById('draw-pile');
            currentTopCard = data.topCard; // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î³Î¹Î± Ï„Î¿ top card

            if (data.isMyTurn) {
                if (data.penalty > 0) {
                    ind.style.color = "#ff6666";
                    ind.style.borderColor = "red";
                    drawPile.style.boxShadow = "0 0 20px red";
                    if (data.penaltyType === 'J') {
                        // Î”Î¹ÏŒÏÎ¸Ï‰ÏƒÎ· UI Î³Î¹Î± Ï„Î¿Î½ Î’Î±Î»Î­: Î”ÎµÎ¯Ï‡Î½ÎµÎ¹ Ï„Î¿ ÏƒÏÎ½Î¿Î»Î¿
                        ind.innerText = `âš ï¸ Î¦Î‘Î• ${data.penalty} ÎšÎ‘Î¡Î¤Î•Î£!`;
                    } else if (data.penaltyType === '2') {
                        ind.innerText = `âš ï¸ Î£Î—ÎšÎ©Î£Î• ÎœÎ™Î‘ ÎšÎ‘Î¡Î¤Î‘!`;
                    } else {
                        ind.innerText = `âš ï¸ Î Î‘Î¡Î• ${data.penalty} ÎšÎ‘Î¡Î¤Î•Î£!`;
                    }
                } else {
                    ind.innerText = "ğŸŸ¢ Î•Î™ÎÎ‘Î™ Î— Î£Î•Î™Î¡Î‘ Î£ÎŸÎ¥";
                    ind.style.color = "#4f4";
                    ind.style.borderColor = "#4f4";
                    drawPile.style.boxShadow = "none";
                }
            } else {
                ind.innerText = "â³ Î ÎµÏÎ¯Î¼ÎµÎ½Îµ...";
                ind.style.color = "#aaa";
                ind.style.borderColor = "#555";
                drawPile.style.boxShadow = "none";
            }

            const suitInd = document.getElementById('suit-indicator');
            if (data.activeSuit) {
                suitInd.style.display = 'flex';
                suitInd.innerText = data.activeSuit;
                suitInd.style.color = (data.activeSuit === 'â™¥' || data.activeSuit === 'â™¦') ? 'red' : 'black';
            } else { suitInd.style.display = 'none'; }

            if (data.topCard) document.getElementById('top-card-spot').innerHTML = createCardHTML(data.topCard);
            if (data.myHand) renderHand(data.myHand);
            renderOpponents(data.players);
        });

        socket.on('notification', (msg) => {
            const ind = document.getElementById('turn-indicator');
            ind.innerText = msg;
            ind.style.color = "gold";
        });

        socket.on('invalidMove', () => {
            document.querySelectorAll('.hand-card').forEach(c => c.classList.add('shake'));
            setTimeout(() => document.querySelectorAll('.hand-card').forEach(c => c.classList.remove('shake')), 200);
        });

        function play(index, value, suit) {
            // Î›Î¿Î³Î¹ÎºÎ® Î†ÏƒÏƒÎ¿Ï…:
            // Î‘Î½ ÎµÎ¯Î½Î±Î¹ Î†ÏƒÏƒÎ¿Ï‚ ÎšÎ‘Î™ Ï„Î¿ ÎºÎ¬Ï„Ï‰ Ï†ÏÎ»Î»Î¿ ÎµÎ¯Î½Î±Î¹ Î†ÏƒÏƒÎ¿Ï‚:
            // Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î­Ï‡Î¿Ï…Î½ Î¯Î´Î¹Î¿ Ï‡ÏÏÎ¼Î± ÎºÎ±Î¹ Ï€Î±Î¯Î¶ÎµÏ„Î±Î¹ Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»Î»Î±Î³Î®.
            if (value === 'A' && currentTopCard && currentTopCard.value === 'A') {
                if (suit === currentTopCard.suit) {
                    // Î Î±Î¯Î¾Ï„Î¿ Î±Ï€ÎµÏ…Î¸ÎµÎ¯Î±Ï‚ (Ï‡Ï‰ÏÎ¯Ï‚ Modal)
                    socket.emit('playCard', { index: index, declaredSuit: null });
                } else {
                    // Î›Î¬Î¸Î¿Ï‚ ÎºÎ¯Î½Î·ÏƒÎ· (Î¸Î± Ï„Î¿ ÎºÏŒÏˆÎµÎ¹ Î¿ server, Î±Î»Î»Î¬ Î±Ï‚ ÎºÎ¬Î½Î¿Ï…Î¼Îµ shake)
                    document.querySelectorAll('.hand-card')[index].classList.add('shake');
                    setTimeout(() => document.querySelectorAll('.hand-card')[index].classList.remove('shake'), 200);
                }
            }
            // Î‘Î½ ÎµÎ¯Î½Î±Î¹ Î†ÏƒÏƒÎ¿Ï‚ ÎºÎ±Î¹ Ï„Î¿ ÎºÎ¬Ï„Ï‰ Î”Î•Î ÎµÎ¯Î½Î±Î¹ Î†ÏƒÏƒÎ¿Ï‚:
            else if (value === 'A') {
                selectedAceIndex = index;
                document.getElementById('ace-modal').style.display = 'flex';
            } else {
                socket.emit('playCard', { index: index, declaredSuit: null });
            }
        }

        function confirmAce(suit) {
            document.getElementById('ace-modal').style.display = 'none';
            socket.emit('playCard', { index: selectedAceIndex, declaredSuit: suit });
        }

        function drawCardAnim() {
            const pile = document.getElementById('draw-pile');
            pile.style.transform = "scale(0.9)";
            setTimeout(() => pile.style.transform = "translate(-50%, -50%)", 100);
            socket.emit('drawCard');
        }

        function renderHand(hand) {
            const div = document.getElementById('my-hand');
            div.innerHTML = hand.map((c, i) => {
                const color = (c.suit === 'â™¥' || c.suit === 'â™¦') ? 'red' : '';
                return `<div class="card hand-card ${color} new-card" onclick="play(${i}, '${c.value}', '${c.suit}')">
                    <div style="line-height:0.8">${c.value}<br>${c.suit}</div>
                    <div style="font-size:35px; align-self:center">${c.suit}</div>
                    <div style="transform:rotate(180deg); line-height:0.8">${c.value}<br>${c.suit}</div>
                </div>`;
            }).join('');
        }

        function createCardHTML(c) {
            const color = (c.suit === 'â™¥' || c.suit === 'â™¦') ? 'red' : '';
            return `<div class="card ${color} new-card">
                <div style="line-height:0.8">${c.value}<br>${c.suit}</div>
                <div style="font-size:35px; align-self:center">${c.suit}</div>
                <div style="transform:rotate(180deg); line-height:0.8">${c.value}<br>${c.suit}</div>
            </div>`;
        }

        function renderOpponents(players) {
            const others = players.filter(p => p.id !== myId);
            const pos = ['opp-top', 'opp-left', 'opp-right'];
            pos.forEach(p => document.getElementById(p).innerHTML = '');
            others.forEach((p, i) => {
                if(i<3) {
                    let cards = '';
                    for(let k=0; k<p.handCount; k++) cards += '<div class="mini-card"></div>';
                    document.getElementById(pos[i]).innerHTML = `
                        <div class="opp-name">${p.name}</div>
                        <div style="display:flex; justify-content:center">${cards}</div>`;
                }
            });
        }
    </script>
</body>
</html>
